{% extends "base.html" %} {% block content %}
<br /><br />
<!-- templates/base.html (or the relevant header template) -->
<h1>Products for sale:</h1>
<div class="container">
  <!-- Add this form at the top -->
  <form method="GET" action="{{ url_for('index.index') }}" class="form-inline my-2">
    <input
      class="form-control mr-sm-2"
      type="search"
      id="search_query"
      name="search_query"
      placeholder="Search products"
      value="{{ request.args.get('search_query', '') }}"
    />
    <!-- Category selectors container -->
    <div id="category-selectors">
      <!-- Initial parent category selector here -->
    </div>
    <button class="btn btn-outline-success" type="submit">Search</button>
    <!-- Add this in the appropriate place within your form -->
    <div class="dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button">
        Categories
      </button>
      <ul class="dropdown-menu">
        {% for category in categories.values() %}
          {% include 'category_dropdown_item.html' %}
        {% endfor %}
      </ul>
    </div>
  </form>
  <!-- Filter Input Box for Price -->
  <div class="row mb-4">
    <div class="col-md-6 offset-md-3">
      <div class="row">
        <!-- Min Price Input -->
        <div class="col-md-6">
          <label for="minPrice">Min Price:</label>
          <input
            type="number"
            id="minPrice"
            class="form-control"
            placeholder="Min Price"
          />
        </div>
        <!-- Max Price Input -->
        <div class="col-md-6">
          <label for="maxPrice">Max Price:</label>
          <input
            type="number"
            id="maxPrice"
            class="form-control"
            placeholder="Max Price"
          />
        </div>
        <div class="col-md-6">
          <button type="submit", id="maxPrice", onclick="filterProducts()">Submit</button>
        </div>
      </div>
    </div>
  </div>



  <h2>Products:</h2>

  <div class="row" id="productContainer">
    <!-- Loop through available products and display each one as a card -->
    {% for product in avail_products %}
    <!-- Get total quantity from the passed data -->
    {% set total_quantity = product_quantities[product.product_id] %}
    <div class="col-md-4 product-card" data-price="{{ product.price }}">
      <div class="card mb-4">
        <!-- Wrap the image and product details in a link -->
        <a href="{{ url_for('products.product_page', product_id=product.product_id) }}" style="text-decoration: none; color: inherit;">
          <!-- Product Image -->
          <img
            src="{{ product.image_url }}"
            class="card-img-top"
            alt="{{ product.name }}"
          />
          <div class="card-body">
            <!-- Product Name -->
            <h5 class="card-title">{{ product.name }}</h5>
            <!-- Smaller Product ID -->
            <p class="text-muted" style="font-size: 0.85em">
              Product ID: {{ product.product_id }}
            </p>
            <!-- Product Summary -->
            <p class="card-text">{{ product.summary }}</p>
            <!-- Price in bold -->
            <p class="card-price font-weight-bold">
              Price: ${{ "%.2f"|format(product.price) }}
            </p>
          </div>
        </a>
        <!-- Buy Now Form outside the link -->
        <div class="card-body">
          {% if total_quantity > 0 %}
          <form
            action="{{ url_for('cart.add_to_cart', product_id=product.product_id) }}"
            method="POST"
          >
            <!-- CSRF protection -->
            {% if csrf_token %} {{ csrf_token() }} {% endif %}
            <button type="submit" class="btn btn-primary">Buy Now</button>
          </form>
          {% else %}
          <p class="text-danger text-center">Currently unavailable.</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  function filterProducts() {
    // Get the min and max price from the input fields
    let minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
    let maxPrice =
      parseFloat(document.getElementById("maxPrice").value) || Infinity;

    // Get all the product cards
    let productCards = document.querySelectorAll(".product-card");

    // Loop through each product card and filter by price
    productCards.forEach((card) => {
      let productPrice = parseFloat(card.getAttribute("data-price"));

      // Show the card if the product price is within the range
      if (productPrice >= minPrice && productPrice <= maxPrice) {
        card.style.display = "";
      } else {
        card.style.display = "none";
      }
    });
  }

  $(function() {
    $("#search_query").autocomplete({
      source: function(request, response) {
        $.ajax({
          url: "{{ url_for('products.autocomplete') }}",
          dataType: "json",
          data: {
            q: request.term
          },
          success: function(data) {
            response(data.matching_results);
          }
        });
      },
      minLength: 2,
    });
  });

  function loadSubcategories(level) {
    var selectedCategoryId = document.getElementById('category_id_' + level).value;
    // Remove any child selectors
    var container = document.getElementById('category-selectors');
    while (container.children.length > level + 1) {
      container.removeChild(container.lastChild);
    }

    if (selectedCategoryId) {
      fetch("{{ url_for('categories.get_children') }}?parent_id=" + selectedCategoryId)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            // Create new select element
            var select = document.createElement('select');
            select.name = 'category_id';
            select.id = 'category_id_' + (level + 1);
            select.className = 'form-control mr-sm-2 mt-2';
            select.onchange = function() { loadSubcategories(level + 1); };

            // Add default option
            var defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'Select Subcategory';
            select.appendChild(defaultOption);

            // Populate with child categories
            data.forEach(function(category) {
              var option = document.createElement('option');
              option.value = category.category_id;
              option.text = category.category_name;
              select.appendChild(option);
            });

            container.appendChild(select);
          }
        });
    }
  }
</script>

<!-- Include jQuery library in your base template or index.html -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include jQuery UI library for autocomplete -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>

<style>
/* Dropdown Styles */
.dropdown-menu {
  position: absolute;
  display: none;
  top: 100%;
  left: 0;
}

.dropdown-submenu {
  position: relative;
}

.dropdown-submenu > .dropdown-menu {
  top: 0;
  left: 100%;
}

.dropdown:hover > .dropdown-menu,
.dropdown-submenu:hover > .dropdown-menu {
  display: block;
}

.dropdown-item {
  display: block;
  width: 100%;
  padding: 0.25rem 1.5rem;
  text-decoration: none;
  color: #212529;
}

.dropdown-item:hover {
  background-color: #f8f9fa;
  color: #16181b;
}
</style>

<br /><br />

{% if current_user.is_authenticated %}
<h2>Your recent orders:</h2>

<!-- Card container for order history -->
<div class="container">
  <div class="row">
    <!-- Loop through order history and display each one as a card -->
    {% for order in order_history %}
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-body">
          <!-- Order ID -->
          <p class="text-muted" style="font-size: 0.85em">
            Order ID: {{ order.order_id }}
          </p>

          <!-- Total Amount and Number of Items -->
          <p class="card-text">
            Total Amount: ${{ "%.2f"|format(order.total_amount) }}
          </p>
          <p class="card-text">Number of Items: {{ order.num_items }}</p>

          <!-- Fulfillment Status -->
          <p class="text-muted">Status: {{ order.fulfillment_status }}</p>

          <!-- Time of Order Creation -->
          <p class="text-muted">Ordered on: {{ order.created_at }}</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% else %}
<p>
  <a href="{{ url_for('users.login') }}">Log in</a> to see your order history!
</p>
{% endif %} {% endblock %}
